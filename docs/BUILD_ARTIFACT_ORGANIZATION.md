# Build Artifact Organization & Migration Guide

## Overview

All build artifacts (`.lib`, `.idb`, `.pdb`, `.dll`, `.exe`) are now organized in the `bin/` and `build/` folder structure instead of being scattered throughout the source tree. This keeps the source directories clean and organized.

## Directory Structure

```
AutoBBS/
├── core/                          # Source code (clean, no artifacts)
│   ├── AsirikuyCommon/
│   ├── AsirikuyFrameworkAPI/
│   ├── Log/
│   ├── OrderManager/
│   ├── SymbolAnalyzer/
│   ├── AsirikuyTechnicalAnalysis/
│   ├── TradingStrategies/
│   ├── NTPClient/
│   ├── AsirikuyEasyTrade/
│   ├── CTesterFrameworkAPI/
│   ├── UnitTests/
│   └── AsirikuyRWrapper/
│
├── build/                         # Build system files
│   └── vs2010/
│       └── projects/              # Generated Visual Studio projects
│
├── bin/                           # All final build outputs
│   └── vs2010/
│       ├── x32/
│       │   ├── Debug/
│       │   │   └── lib/           # Static libraries & debug symbols
│       │   └── Release/
│       │       └── lib/
│       └── x64/
│           ├── Debug/
│           │   ├── lib/           # Static libraries & debug symbols
│           │   └── *.dll          # Shared libraries
│           └── Release/
│               ├── lib/           # Libraries & debug symbols (this is the main folder)
│               └── *.dll          # Shared DLLs
│
└── releases/                      # Release packages
    └── AsirikuyFramework-{date}/

```

## Artifact Types

### Library Files (`.lib`)
- **Static libraries**: `*.lib` files for linking
- **Location**: `bin/vs2010/{arch}/{config}/lib/`
- **Generated by**: Premake4 via MSBuild
- **Size**: 19-280 KB per library

**Example files:**
```
bin/vs2010/x64/Release/lib/
├── AsirikuyCommon.lib           (187 KB)
├── AsirikuyEasyTrade.lib        (19.5 KB)
├── AsirikuyTechnicalAnalysis.lib (56 KB)
├── Log.lib                      (50 KB)
├── OrderManager.lib             (67 KB)
├── SymbolAnalyzer.lib           (280 KB)
└── trading_strategies.lib       (525 KB)
```

### Debug Information Files (`.pdb`)
- **Program Database files**: Symbol information for debugging
- **Location**: `bin/vs2010/{arch}/{config}/lib/` (same as `.lib`)
- **Generated by**: MSVC linker
- **Size**: 86 KB - 643 KB per module
- **Note**: Essential for debugging with Visual Studio

**Example files:**
```
AsirikuyCommon.pdb              (135 KB)
AsirikuyTechnicalAnalysis.pdb   (102 KB)
NTPClient.pdb                   (643 KB) - Largest due to Boost templates
```

### Incremental Database Files (`.idb`)
- **Intermediate compiler database**: Used by Visual C++ for incremental compilation
- **Location**: `bin/vs2010/{arch}/{config}/lib/`
- **Generated by**: MSVC compiler
- **Size**: 109 KB - 1.6 MB per module
- **Note**: Can be deleted if needed; will be regenerated next build

**Example files:**
```
NTPClient.idb                   (1.6 MB) - Largest due to Boost headers
AsirikuyTechnicalAnalysis.idb   (330 KB)
```

### Dynamic Link Libraries (`.dll`)
- **Shared libraries**: `.dll` files for runtime
- **Location**: `bin/vs2010/{arch}/{config}/`
- **Generated by**: Premake4 via MSBuild
- **Example**: `AsirikuyFrameworkAPI.dll` (681 KB for x64 Release)

## Configuration Directories

### Multi-Architecture Support
```
bin/vs2010/
├── x32/          # 32-bit binaries
│   ├── Debug/    # Debug configuration (smaller optimizations)
│   └── Release/  # Release configuration (optimized)
└── x64/          # 64-bit binaries
    ├── Debug/
    └── Release/
```

### Configuration Details
| Config | Purpose | Optimization | Debug Symbols |
|--------|---------|--------------|--------------|
| x32/Debug | 32-bit testing | Minimal | Full (*.pdb) |
| x32/Release | 32-bit production | Size/Speed optimized | Full (*.pdb) |
| x64/Debug | 64-bit testing | Minimal | Full (*.pdb) |
| x64/Release | 64-bit production (MT4) | Size/Speed optimized | Full (*.pdb) |

## Premake4 Configuration

All `premake4.lua` files have been updated to include Windows target directories:

### Example Configuration
```lua
-- For Windows platforms
configuration{"windows", "x32", "Debug"}
  targetdir("../../bin/" .. _ACTION .. "/x32/Debug/lib")
configuration{"windows", "x32", "Release"}
  targetdir("../../bin/" .. _ACTION .. "/x32/Release/lib")
configuration{"windows", "x64", "Debug"}
  targetdir("../../bin/" .. _ACTION .. "/x64/Debug/lib")
configuration{"windows", "x64", "Release"}
  targetdir("../../bin/" .. _ACTION .. "/x64/Release/lib")

-- Same pattern for macOS and Linux
```

### Affected Files
All core module `premake4.lua` files have been updated:
- ✅ `core/AsirikuyCommon/premake4.lua`
- ✅ `core/Log/premake4.lua`
- ✅ `core/OrderManager/premake4.lua`
- ✅ `core/SymbolAnalyzer/premake4.lua`
- ✅ `core/AsirikuyTechnicalAnalysis/premake4.lua`
- ✅ `core/AsirikuyRWrapper/premake4.lua`
- ✅ `core/AsirikuyFrameworkAPI/premake4.lua`
- ✅ `premake4.lua` (root level)

## Migration Summary

### Migration Completed
- **Date**: December 6, 2025
- **Script**: `scripts/migrate-artifacts.ps1`
- **Files migrated**: 20
- **Total size**: 5.09 MB

### Before Migration
```
core/AsirikuyCommon/
├── AsirikuyCommon.lib        ❌ (in source dir)
├── AsirikuyCommon.idb        ❌ (in source dir)
└── AsirikuyCommon.pdb        ❌ (in source dir)

core/Log/
├── Log.lib                   ❌ (in source dir)
├── Log.idb                   ❌ (in source dir)
└── Log.pdb                   ❌ (in source dir)
... (total 20 files scattered)
```

### After Migration
```
core/AsirikuyCommon/           ✅ (clean, no artifacts)
core/Log/                      ✅ (clean, no artifacts)
... (all source directories clean)

bin/vs2010/x64/Release/lib/
├── AsirikuyCommon.lib        ✅ (organized)
├── AsirikuyCommon.idb        ✅ (organized)
├── AsirikuyCommon.pdb        ✅ (organized)
├── Log.lib                   ✅ (organized)
├── Log.idb                   ✅ (organized)
├── Log.pdb                   ✅ (organized)
... (all 20 files in one location)
```

## Future Builds

### After Running Premake4 & Rebuild
Going forward, all new builds will automatically place artifacts in the correct locations:

```powershell
# Generate Visual Studio projects with proper target directories
.\premake4.exe vs2010

# Build will now output to: bin/vs2010/x64/Release/lib/
# Instead of: core/ModuleName/
```

### Verification
After rebuilding:
```powershell
# Check that source is clean
Get-ChildItem -Path "core" -Recurse -Include "*.lib","*.pdb","*.idb"
# Should return: (nothing)

# Check that artifacts are in build folder
Get-ChildItem -Path "bin/vs2010/x64/Release/lib" -Include "*.lib"
# Should show all libraries
```

## Using the Migration Script

### Running the Script
```powershell
# Dry run (show what would be moved without executing)
.\scripts\migrate-artifacts.ps1 -DryRun

# Perform actual migration
.\scripts\migrate-artifacts.ps1

# Verbose output (shows every file operation)
.\scripts\migrate-artifacts.ps1 -Verbose
```

### Script Parameters
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `-SourceDir` | string | `e:\AutoBBS` | Root directory containing source code |
| `-DestinationDir` | string | Same as SourceDir | Destination for artifacts (usually same) |
| `-DryRun` | switch | False | Show what would be moved without executing |
| `-Verbose` | switch | False | Show detailed information for each file |

## Benefits of This Organization

### Clean Source Tree
- ✅ Source code directories remain pristine
- ✅ Easier to version control (ignore build artifacts)
- ✅ Clearer project structure
- ✅ Faster searches in source tree

### Organized Build Output
- ✅ All artifacts in one predictable location
- ✅ Easy to find debugging symbols
- ✅ Support for multiple configurations
- ✅ Easy cleanup (just delete `bin/` folder)

### Build System Consistency
- ✅ Same structure across all platforms (Windows/macOS/Linux)
- ✅ Easier build scripts
- ✅ Better CI/CD integration
- ✅ Predictable dependency resolution

### Release Management
- ✅ Release packages can reference centralized artifacts
- ✅ No need to search multiple directories
- ✅ Simplified build process
- ✅ Better disk space management

## Disk Space Usage

### Per Configuration
| Config | Typical Size | Main Files |
|--------|--------------|-----------|
| x32/Debug | ~50 MB | Libraries (*.lib) + Debug info (*.pdb) + IDB |
| x32/Release | ~45 MB | Libraries + Release debug symbols |
| x64/Debug | ~55 MB | Libraries + Debug info + IDB |
| x64/Release | ~50 MB | Libraries + DLL + Debug info |

### With Cleanup
Using the cleanup scripts from `BUILD_CLEANUP_STRATEGY.md`:
- Remove `.idb` files: Saves ~300 MB per configuration
- Keep only `.lib` and `.pdb`: ~40 MB per configuration
- Release packages only: ~65 MB per release

## Troubleshooting

### Files Still in Source Directory
**Problem**: After rebuilding, artifacts appear in source directories again.

**Solution**: 
1. Verify `premake4.lua` was updated correctly
2. Regenerate projects: `premake4.exe vs2010`
3. Rebuild: `msbuild` or through Visual Studio

**Check**:
```powershell
# Verify premake4.lua has Windows configurations
Select-String -Path "core/*/premake4.lua" -Pattern "configuration.*windows"
```

### Missing DLLs at Runtime
**Problem**: DLL not found when running executable.

**Solution**:
1. Check `bin/vs2010/x64/Release/` for DLL
2. Verify configuration matches (Release vs Debug)
3. Update PATH or copy DLL to executable location

**Example**:
```powershell
# Find DLL
Get-ChildItem -Path "bin" -Recurse -Filter "*.dll"

# Copy to expected location if needed
Copy-Item "bin/vs2010/x64/Release/AsirikuyFrameworkAPI.dll" "."
```

## Related Documentation

- `BUILD_CLEANUP_STRATEGY.md` - How to clean up build artifacts
- `BUILD_CONFIGURATION.md` - Detailed build configuration guide
- `BUILD_SYSTEM_COMPLETE.md` - Complete build system overview
- `premake4-minimal.lua` - Root level build configuration

## Next Steps

1. **Verify clean builds work**: Run a full rebuild and check that artifacts are in the correct locations
2. **Update build scripts**: Ensure all build scripts reference `bin/` folder correctly
3. **Update CI/CD pipelines**: Point to new artifact locations
4. **Update documentation**: Add to build instructions (done!)
5. **Regular cleanup**: Use cleanup scripts to manage disk space

## Summary

Build artifacts are now properly organized in `bin/vs2010/{arch}/{config}/lib/` instead of being scattered throughout the source tree. Source directories remain clean, making the project easier to maintain and version control.

All new builds will automatically use the correct target directories thanks to updated `premake4.lua` files across all core modules.
