# Kantu Strategy Review

## Executive Summary

**Strategy ID**: 18 (KANTU)  
**File**: `dev/TradingStrategies/src/strategies/Kantu.c` (378 lines)  
**Status**: ‚úÖ **ACTIVE** - Registered in `AsirikuyStrategies.c`  
**Frontend Support**: ‚úÖ MQL4 and MQL5 frontends available  
**Dependencies**: `KantuStrategies.c` (shared library for signal generation)

---

## Strategy Overview

**Type**: Price Action Based Trading System (Generated with Kanut System Generator)  
**Timeframes**: Any (supports daily and intraday)  
**Concept**: A flexible trading system that uses external CSV files to define trading rules. The strategy can load pre-generated trading systems from files, making it highly configurable and extensible.

### Key Characteristics
- **External System Files**: Can load trading rules from CSV files via `SELECT_KANTU_SYSTEM_FILE`
- **Multiple Volatility Modes**: 5 different ways to calculate ATR/volatility
- **Dynamic Stop Loss (DSL)**: 7 different DSL types for advanced stop loss management
- **Thread Safety**: Uses critical sections for MT4 execution safety
- **Flexible Entry Signals**: Uses `isLongEntrySignal()` and `isShortEntrySignal()` from KantuStrategies
- **Trailing Stop**: Supports trailing stop loss functionality
- **AFMTL**: Supports "Always Follow Moving Trailing Loss" mode

---

## Strategy Logic

### 1. System File Loading

**External CSV Files**:
- If `SELECT_KANTU_SYSTEM_FILE != 0`, loads trading rules from external CSV file
- Calls `getKantuSignal()` to load and parse the system file
- Overrides internal strategy selection when file is specified

### 2. Volatility Calculation

**5 Calculation Modes** (via `VOLATILITY_CALCULATION_MODE`):

| Mode | Value | Description |
|------|-------|-------------|
| **MODE_KANTU** | 0 | Kantu default ATR calculation |
| **MODE_DAILY_ATR_SHIFT_ZERO** | 1 | Daily ATR with safe shift zero (for Open price only simulations) |
| **MODE_DAILY_ATR_NORMAL** | 2 | Normal daily ATR |
| **MODE_DAILY_RANGE_SHIFT_ZERO** | 3 | Average Daily Range with safe shift zero |
| **MODE_DAILY_RANGE_NORMAL** | 4 | Normal average daily range |

**Kantu ATR Calculation**:
- **Daily Timeframe (1440 min)**: Manual calculation using True Range over N periods
- **Other Timeframes**: Uses `iAtrWholeDaysSimple()` function

### 3. Entry Logic

**Entry Signals**:
- **Long Entry**: `isLongEntrySignal(pParams, SELECTED_STRATEGY_ID, shift1Index, atr)`
- **Short Entry**: `isShortEntrySignal(pParams, SELECTED_STRATEGY_ID, shift1Index, atr)`
- Signals are generated by `KantuStrategies.c` library
- Strategy ID is selected via `SELECTED_STRATEGY_ID` parameter

**Stop Loss Management**:
- Minimum stop loss enforced (0.15 for JPY pairs, 0.0015 for others)
- When updating existing orders, preserves current stop loss distance
- Uses ATR multiplier: `stopLoss = atr * SL_ATR_MULTIPLIER`

### 4. Dynamic Stop Loss (DSL)

**7 DSL Types** (via `DSL_TYPE`):

| Type | Value | Formula | Description |
|------|-------|---------|-------------|
| **DSL_NONE** | 0 | N/A | No dynamic stop loss |
| **DSL_LINEAR** | 1 | `newSL = orderAge*(-stopLoss/BE_BARS)+stopLoss` | Linear progression to breakeven |
| **DSL_LOG** | 2 | `newSL = stopLoss+(stopLoss/(-log(BE_BARS)))*log(orderAge+1)` | Logarithmic progression |
| **DSL_PARABOLIC** | 3 | `newSL = stopLoss+(-stopLoss/(BE_BARS¬≤))*orderAge¬≤` | Parabolic progression |
| **DSL_SQUARE** | 4 | `newSL = stopLoss+(-stopLoss/‚àöBE_BARS)*‚àöorderAge` | Square root progression |
| **DSL_SQUARE_WITH_SKIP** | 5 | Square root + skip logic based on bar direction | Square root with bar filtering |
| **DSL_X4** | 6 | `newSL = stopLoss+(-stopLoss/BE_BARS‚Å¥)*orderAge‚Å¥` | Power of 4 progression |
| **DSL_X025** | 7 | `newSL = stopLoss+(-stopLoss/BE_BARS^0.25)*orderAge^0.25` | Power of 0.25 progression |

**DSL Exit Types** (via `DSL_EXIT_TYPE`):
- Controls when DSL is applied (not fully documented in code)

### 5. Trailing Stop Loss

**Trailing Stop Logic**:
- Uses `TL_ATR_MULTIPLIER` to calculate trailing distance
- For SELL orders: Moves stop loss when `cOpen(orderAge) - ask[0] > trailingStop`
- For BUY orders: Moves stop loss when `bid[0] - cOpen(orderAge) > trailingStop`
- Preserves take profit when modifying

### 6. AFMTL (Always Follow Moving Trailing Loss)

**AFMTL Mode** (via `USE_AFMTL`):
- When enabled, continuously moves stop loss closer to entry price
- For SELL: Moves SL when `ask[0] + stopLoss < currentStopLoss`
- For BUY: Moves SL when `bid[0] - stopLoss > currentStopLoss`
- Uses original stop loss value as reference

### 7. Risk Management

**Stop Loss Calculation**:
```
stopLoss = atr * SL_ATR_MULTIPLIER
```

**Take Profit Calculation**:
```
takeProfit = atr * TP_ATR_MULTIPLIER
```

**Minimum Stop Loss**:
- JPY pairs: 0.15 pips
- Other pairs: 0.0015 (15 pips)

**Timed Exit**:
- Supports timed exits via `TIMED_EXIT_BARS` parameter
- Uses `checkTimedExit()` when parameter is non-zero

---

## Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `SELECTED_STRATEGY_ID` | int | Selects a strategy ID from the Kantu library |
| `VOLATILITY_CALCULATION_MODE` | int | How to calculate volatility (0-4) |
| `TL_ATR_MULTIPLIER` | double | Trailing stop loss as ATR multiple |
| `USE_AFMTL` | BOOL | Enable Always Follow Moving Trailing Loss |
| `SELECT_KANTU_SYSTEM_FILE` | int | Load external CSV system file (0 = disabled) |
| `DSL_BREAKEVEN_BARS` | int | Number of bars to reach breakeven for DSL |
| `DSL_TYPE` | int | Dynamic Stop Loss type (0-7) |
| `DSL_EXIT_TYPE` | int | DSL exit condition type |

---

## Code Quality Assessment

### ‚úÖ Strengths
1. **Thread Safety**: Uses critical sections for MT4 execution safety
2. **Flexible**: Supports external system files and multiple volatility modes
3. **Advanced DSL**: Sophisticated dynamic stop loss system with 7 types
4. **Well-Structured**: Clear separation of concerns
5. **Error Handling**: Proper error checking and logging
6. **Symbol-Specific Logic**: Handles JPY pairs differently (minimum stop)

### ‚ö†Ô∏è Issues Found

1. **Incorrect Header Documentation** (`Kantu.h` lines 3-4, 52):
   - Header file says "Atipaq trading system" instead of "Kantu"
   - Function documentation says "Runs the Atipaq trading strategy"
   - **Impact**: Confusing documentation, copy-paste error

2. **Commented Code** (Lines 226, 242):
   - Debug logging statements are commented out
   - Should be removed or uncommented if needed

3. **TODO Comment** (Line 303):
   - TODO comment about following stop loss closer in longer term trends
   - Indicates incomplete feature

4. **Complex DSL Logic**:
   - 7 different DSL formulas make the code complex
   - Could benefit from refactoring into separate functions or lookup table

5. **Magic Numbers**:
   - Hardcoded values: 0.15 (JPY min stop), 0.0015 (other pairs min stop)
   - Could be constants or parameters

6. **Incomplete Documentation**:
   - DSL exit types not fully documented
   - Some parameters lack clear descriptions

### üîç Code Complexity
- **Moderate-High Complexity**: ~378 lines with complex DSL logic
- **Readability**: Good - functions are well-named
- **Maintainability**: Moderate - DSL formulas are complex but isolated
- **Dependencies**: High - depends on `KantuStrategies.c` for signal generation

---

## Dependencies

### Internal Dependencies
- `KantuStrategies.h` / `KantuStrategies.c` - **CRITICAL DEPENDENCY**
  - `getKantuSignal()` - Loads external CSV system files
  - `isLongEntrySignal()` - Generates long entry signals
  - `isShortEntrySignal()` - Generates short entry signals
  - `setKantuDSL()` - Sets dynamic stop loss
  - `initKantuFileParams()` - Initializes system file parameters
- `AsirikuyStrategies.h` - Strategy framework
- `InstanceStates.h` - Instance state management
- `AsirikuyTime.h` - Time utilities
- `Logging.h` - Logging functions
- `OrderSignals.h` - Order signal management
- `OrderManagement.h` - Order operations
- `AsirikuyTechnicalAnalysis.h` - Technical analysis utilities
- `EasyTradeCWrapper.hpp` - Easy trade wrapper
- `CriticalSection.h` - Thread safety

### External Dependencies
- `ta_libc.h` - Technical Analysis Library (not directly used, but may be used by KantuStrategies)
- `math.h` - Mathematical functions (log, sqrt, pow)
- `stdlib.h` - Standard library functions

### Related Strategies
- **KantuML** (ID: 22) - Machine learning variant using ensemble predictions
- Both strategies share `KantuStrategies.c` library

---

## Usage Status

### ‚úÖ Active Usage
- **Registered**: Yes, in `AsirikuyStrategies.c` enum (ID: 18)
- **Case Handler**: Present in switch statement
- **Header File**: `Kantu.h` exists and is included
- **Frontend Files**: 
  - `FrontEnds/MQL4_B600/MQL4/Experts/Kantu.mq4`
  - MQL5 support available
- **Framework Integration**: `initKantuFileParams()` called in `AsirikuyFrameworkAPI.c`

### üìä Integration Points
- Called via `runKantu()` function pointer in strategy dispatcher
- Uses standard `StrategyParams` structure
- Follows standard Asirikuy strategy pattern
- Initialized at framework startup

---

## Comparison with Similar Strategies

### Similar Strategies in Codebase
1. **KantuML** - Machine learning variant using ensemble predictions
2. **Coatl** - Also uses external system files (genetic algorithm generated)
3. **AutoBBS** - Complex strategy with multiple modes

### Unique Features of Kantu
- **External CSV System Files**: Only strategy that loads trading rules from external files
- **7 DSL Types**: Most sophisticated dynamic stop loss system
- **5 Volatility Modes**: Most flexible volatility calculation
- **Thread Safety**: Only strategy explicitly using critical sections
- **Kanut System Generator**: Designed to work with external system generator tool

---

## Refactoring Considerations

### For C++ Migration (Phase 2)
- **Complexity**: High - Depends on external library (`KantuStrategies.c`)
- **Estimated Effort**: High (complex DSL logic, external dependencies)
- **Class Structure**:
  ```cpp
  class KantuStrategy : public BaseStrategy {
    // Volatility calculator (strategy pattern)
    // DSL manager (strategy pattern for 7 types)
    // System file loader
    // Trailing stop manager
  };
  ```

### Potential Improvements
1. **Fix Header Documentation**: Correct "Atipaq" references to "Kantu"
2. **Extract DSL Logic**: Create separate DSL calculator class
3. **Remove Commented Code**: Clean up debug statements
4. **Constants**: Extract magic numbers to named constants
5. **Volatility Calculator**: Extract to separate class using strategy pattern
6. **Documentation**: Complete DSL exit type documentation
7. **Refactor DSL Formulas**: Consider lookup table or function pointers

### Refactoring Strategy
1. **Phase 1**: Fix header documentation (quick win)
2. **Phase 2**: Extract DSL logic into separate module
3. **Phase 3**: Extract volatility calculation into strategy pattern
4. **Phase 4**: Refactor KantuStrategies.c dependency
5. **Phase 5**: Optimize and add unit tests

---

## Recommendations

### ‚úÖ **KEEP** - Recommended Reasons:
1. **Active Strategy**: Registered and available in frontends
2. **Unique Functionality**: External CSV system files are unique
3. **Sophisticated**: Advanced DSL system provides significant value
4. **Well-Integrated**: Properly integrated with framework initialization
5. **High Value**: Flexible system that can be extended via external files

### ‚ö†Ô∏è **Fixes Needed**:
1. **Critical**: Fix header documentation (Kantu.h - says "Atipaq")
2. **High Priority**: Remove or document commented code
3. **Medium Priority**: Extract DSL logic for maintainability
4. **Low Priority**: Extract magic numbers to constants
5. **Low Priority**: Complete DSL exit type documentation

### üìù **If Keeping**:
- Include in Phase 2 migration (complex strategy, good refactoring candidate)
- Fix header documentation immediately
- Plan for significant refactoring to improve maintainability
- Consider breaking DSL logic into separate module
- Add comprehensive unit tests
- Document DSL exit types

### üóëÔ∏è **If Removing**:
- Would need to remove from `AsirikuyStrategies.c` enum and switch
- Remove `Kantu.h` include
- Delete `Kantu.c` and `Kantu.h` files
- **Note**: `KantuStrategies.c` is shared with `KantuML` - do not delete
- Remove MQL frontend files (optional, separate from core library)
- **Impact**: ~378 lines removed, ID 18 becomes available
- **Note**: This is a sophisticated, active strategy - removal should be carefully considered

---

## Conclusion

**Kantu is a sophisticated, active strategy with unique external CSV system file support and advanced dynamic stop loss functionality. It's well-integrated with the framework and provides significant flexibility through external system files. The main issues are incorrect header documentation and complex DSL logic that could benefit from refactoring.**

**Recommendation**: ‚úÖ **KEEP** with fixes and refactoring

**Priority Fixes**:
1. Fix header documentation in `Kantu.h` (critical - says "Atipaq" instead of "Kantu")
2. Remove or document commented code
3. Plan for refactoring DSL logic into separate module
4. Extract magic numbers to constants

---

*Review Date: 2024*  
*Reviewed By: AI Assistant*  
*Strategy Version: F4.x.x (2012)*

